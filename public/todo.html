<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dot To Do</title>
    <meta name="theme-color" content="#ED1C24">
    <link rel="apple-touch-icon" href="apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="192x192" href="images/icon-192.png">
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f5f5f5; color: #333; line-height: 1.5; min-height: 100vh; }
        
        .mobile-message { display: none; padding: 60px 24px; text-align: center; background: white; min-height: 100vh; flex-direction: column; align-items: center; justify-content: center; gap: 24px; }
        .mobile-message img { width: 80px; }
        .mobile-message h2 { font-size: 20px; font-weight: 600; color: #333; }
        .mobile-message p { color: #666; font-size: 15px; }
        .mobile-message a { display: inline-block; padding: 14px 32px; background: #ED1C24; color: white; text-decoration: none; border-radius: 24px; font-weight: 600; font-size: 14px; text-transform: uppercase; letter-spacing: 0.5px; }
        .desktop-app { display: block; }
        @media (max-width: 768px) { .mobile-message { display: flex; } .desktop-app { display: none; } }
        
        .container { max-width: 1200px; margin: 0 auto; }
        header { background: white; border-bottom: 3px solid #ED1C24; padding: 20px 32px; position: sticky; top: 0; z-index: 100; }
        .header-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
        .header-left { display: flex; align-items: center; gap: 16px; }
        .header-left a { display: flex; align-items: center; text-decoration: none; }
        .client-logo { width: 44px; height: 44px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 14px; color: white; cursor: pointer; overflow: hidden; background: #f0f0f0; transition: opacity 0.15s ease; }
        .client-logo:hover { opacity: 0.85; }
        .client-logo img { width: 100%; height: 100%; object-fit: cover; }
        .header-logo { height: 44px; width: auto; }
        .header-right { display: flex; align-items: center; gap: 12px; }
        .header-right img { height: 40px; width: auto; }
        .header-controls { display: flex; justify-content: space-between; align-items: center; }
        .filter-select { padding: 10px 40px 10px 14px; border: 1.5px solid #e5e5e5; border-radius: 24px; font-size: 14px; color: #666; background: white; cursor: pointer; min-width: 180px; appearance: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%23999' stroke-width='2'%3E%3Cpolyline points='6 9 12 15 18 9'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 10px center; background-size: 18px; }
        .filter-select:focus { outline: none; border-color: #ED1C24; }
        .date { font-size: 13px; color: #999; font-weight: 500; }
        
        main { padding: 24px 32px; display: grid; grid-template-columns: 1fr 1fr; gap: 24px; }
        .column { display: flex; flex-direction: column; gap: 24px; }
        .section-title { font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 1.5px; color: #999; padding: 10px 0; margin-bottom: 8px; }
        
        .job-card { background: white; border-radius: 12px; padding: 16px 18px; margin-bottom: 10px; box-shadow: 0 1px 3px rgba(0,0,0,0.08); cursor: pointer; transition: all 0.2s ease; }
        .job-card:hover { box-shadow: 0 2px 8px rgba(0,0,0,0.12); }
        .job-card.expanded { cursor: default; }
        .job-header { display: flex; align-items: flex-start; gap: 12px; }
        .job-logo { width: 36px; height: 36px; border-radius: 50%; background: #f0f0f0; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 9px; color: white; flex-shrink: 0; overflow: hidden; margin-top: 1px; }
        .job-logo img { width: 100%; height: 100%; object-fit: cover; }
        .job-main { flex: 1; min-width: 0; }
        .job-title-row { display: flex; align-items: flex-start; justify-content: space-between; gap: 8px; }
        .job-title { font-size: 15px; font-weight: 600; color: #333; }
        .expand-icon { color: #ED1C24; font-size: 18px; transition: transform 0.2s ease; flex-shrink: 0; line-height: 1; margin-top: 2px; }
        .job-card.expanded .expand-icon { transform: rotate(180deg); }
        .job-update-preview { font-size: 13px; color: #555; margin-top: 4px; line-height: 1.4; }
        .job-meta-compact { font-size: 12px; color: #999; display: flex; align-items: center; gap: 6px; margin-top: 10px; flex-wrap: wrap; }
        .job-meta-compact .dot { color: #ddd; }
        .stage-tag { background: #f0f0f0; padding: 2px 8px; border-radius: 10px; font-size: 10px; font-weight: 600; color: #666; text-transform: uppercase; letter-spacing: 0.5px; }
        .days-ago.stale { color: #ED1C24; font-weight: 500; }
        
        .job-expanded { display: none; margin-top: 16px; padding-top: 16px; border-top: 1px solid #f0f0f0; }
        .job-card.expanded .job-expanded { display: block; }
        .section-label { font-size: 10px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; color: #999; margin-bottom: 4px; }
        .job-description { font-size: 14px; color: #666; margin-bottom: 4px; line-height: 1.5; }
        .job-owner { font-size: 13px; color: #666; margin-bottom: 16px; }
        .job-controls { display: flex; gap: 12px; margin-bottom: 12px; flex-wrap: wrap; align-items: flex-end; }
        .control-group { display: flex; flex-direction: column; gap: 4px; }
        .control-label { font-size: 10px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; color: #999; }
        .control-select { padding: 8px 28px 8px 10px; border: 1.5px solid #e5e5e5; border-radius: 20px; font-size: 13px; color: #666; background: white; cursor: pointer; appearance: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%23999' stroke-width='2'%3E%3Cpolyline points='6 9 12 15 18 9'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 8px center; background-size: 14px; }
        .control-select:focus { outline: none; border-color: #ED1C24; }
        
        .toggle { position: relative; display: inline-block; width: 44px; height: 24px; cursor: pointer; }
        .toggle input { opacity: 0; width: 0; height: 0; }
        .toggle-slider { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background-color: #e5e5e5; border-radius: 24px; transition: 0.2s; }
        .toggle-slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; border-radius: 50%; transition: 0.2s; box-shadow: 0 1px 3px rgba(0,0,0,0.2); }
        .toggle input:checked + .toggle-slider { background-color: #ED1C24; }
        .toggle input:checked + .toggle-slider:before { transform: translateX(20px); }
        
        .job-dates { display: flex; gap: 16px; margin-bottom: 16px; flex-wrap: wrap; }
        .date-group { display: flex; flex-direction: column; gap: 4px; }
        .date-input { padding: 8px 12px; border: 1.5px solid #e5e5e5; border-radius: 20px; font-size: 13px; font-family: inherit; color: #666; cursor: pointer; }
        .date-input:focus { outline: none; border-color: #ED1C24; }
        
        .job-actions { display: flex; gap: 10px; align-items: center; margin-top: 6px; }
        .update-input { flex: 1; padding: 10px 14px; border: 1.5px solid #e5e5e5; border-radius: 24px; font-size: 13px; font-family: inherit; }
        .update-input:focus { outline: none; border-color: #ED1C24; }
        .update-input::placeholder { color: #bbb; }
        .pill-btn { padding: 10px 24px; background: #ED1C24; color: white; border: none; border-radius: 24px; font-size: 11px; font-weight: 600; cursor: pointer; text-transform: uppercase; letter-spacing: 1px; transition: background 0.15s ease; }
        .pill-btn:hover { background: #c41820; }
        .pill-btn:disabled { background: #ccc; cursor: not-allowed; }
        .pill-btn.success { background: #22a822; }
        
        .job-footer { display: flex; align-items: center; justify-content: space-between; margin-top: 16px; padding-top: 12px; border-top: 1px solid #f0f0f0; }
        .teams-link { display: inline-flex; align-items: center; justify-content: center; gap: 6px; font-size: 10px; font-weight: 600; color: #999; text-decoration: none; text-transform: uppercase; letter-spacing: 0.5px; height: 24px; padding: 0 14px; border: 1.5px solid #e5e5e5; border-radius: 24px; transition: all 0.15s ease; }
        .teams-link:hover { border-color: #ED1C24; color: #ED1C24; }
        .with-client-toggle { display: flex; align-items: center; gap: 8px; }
        .with-client-label { font-size: 10px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; color: #999; }
        
        .job-row { background: white; border-radius: 12px; padding: 12px 16px; margin-bottom: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.08); cursor: pointer; transition: all 0.2s ease; }
        .job-row:hover { box-shadow: 0 2px 8px rgba(0,0,0,0.12); }
        .job-row .job-header { align-items: center; }
        .job-row .job-logo { width: 28px; height: 28px; font-size: 8px; margin-top: 0; }
        .job-row .job-main { display: flex; align-items: center; gap: 12px; }
        .job-row .job-title { font-size: 14px; flex: 1; }
        .job-row .job-meta-inline { font-size: 12px; color: #999; display: flex; align-items: center; gap: 6px; flex-shrink: 0; }
        
        .empty-section { color: #999; font-size: 13px; padding: 20px; text-align: center; background: white; border-radius: 12px; border: 2px dashed #e5e5e5; }
        .single-client .job-logo { display: none; }
        .loading { grid-column: 1 / -1; text-align: center; padding: 60px 24px; color: #999; }
        .loading-spinner { width: 40px; height: 40px; border: 3px solid #e5e5e5; border-top-color: #ED1C24; border-radius: 50%; animation: spin 0.8s linear infinite; margin: 0 auto 16px; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .pin-screen { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: #fff; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 2000; transition: opacity 0.3s ease, visibility 0.3s ease; }
        .pin-screen.hidden { opacity: 0; visibility: hidden; }
        .pin-logo { width: 80px; margin-bottom: 2rem; }
        .pin-title { font-size: 14px; color: #999; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 1.5rem; }
        .pin-dots { display: flex; gap: 12px; margin-bottom: 2rem; }
        .pin-dot { width: 16px; height: 16px; border-radius: 50%; border: 2px solid #e5e5e5; background: transparent; transition: all 0.15s ease; }
        .pin-dot.filled { background: #ED1C24; border-color: #ED1C24; }
        .pin-dot.error { border-color: #ED1C24; animation: shake 0.4s ease; }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-8px); } 75% { transform: translateX(8px); } }
        .pin-keypad { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; max-width: 280px; }
        .pin-key { width: 72px; height: 72px; border-radius: 50%; border: 1.5px solid #e5e5e5; background: #fff; font-size: 1.75rem; font-weight: 500; color: #000; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.15s ease; }
        .pin-key:hover { border-color: #ED1C24; }
        .pin-key:active { background: #f5f5f5; }
        .pin-key.empty { border: none; background: transparent; cursor: default; }
        .pin-key.delete { font-size: 1.25rem; }
        
        .toast { position: fixed; bottom: 24px; left: 50%; transform: translateX(-50%); padding: 12px 24px; border-radius: 24px; font-size: 14px; font-weight: 500; z-index: 3000; opacity: 0; transition: opacity 0.2s ease; pointer-events: none; }
        .toast.visible { opacity: 1; }
        .toast.error { background: #333; color: white; }
        .toast.success { background: #22a822; color: white; }
    </style>
</head>
<body>
    <div class="toast" id="toast"></div>

    <div class="pin-screen" id="pin-screen">
        <img src="images/Robot.png" alt="Dot" class="pin-logo">
        <p class="pin-title">Enter PIN</p>
        <div class="pin-dots">
            <div class="pin-dot" id="dot-0"></div>
            <div class="pin-dot" id="dot-1"></div>
            <div class="pin-dot" id="dot-2"></div>
            <div class="pin-dot" id="dot-3"></div>
        </div>
        <div class="pin-keypad">
            <button class="pin-key" onclick="enterPin(1)">1</button>
            <button class="pin-key" onclick="enterPin(2)">2</button>
            <button class="pin-key" onclick="enterPin(3)">3</button>
            <button class="pin-key" onclick="enterPin(4)">4</button>
            <button class="pin-key" onclick="enterPin(5)">5</button>
            <button class="pin-key" onclick="enterPin(6)">6</button>
            <button class="pin-key" onclick="enterPin(7)">7</button>
            <button class="pin-key" onclick="enterPin(8)">8</button>
            <button class="pin-key" onclick="enterPin(9)">9</button>
            <button class="pin-key empty"></button>
            <button class="pin-key" onclick="enterPin(0)">0</button>
            <button class="pin-key delete" onclick="deletePin()">‚å´</button>
        </div>
    </div>

    <div class="mobile-message">
        <img src="images/Robot.png" alt="Dot">
        <h2>Best on desktop</h2>
        <p>This view is designed for bigger screens.<br>Use Remote for quick actions on mobile.</p>
        <a href="remote.html">Open Remote</a>
    </div>

    <div class="desktop-app">
        <div class="container">
            <header>
                <div class="header-top">
                    <div class="header-left">
                        <a href="hub.html" title="Home">
                            <div class="client-logo" id="header-client-logo">
                                <img src="images/logos/HUN.png" alt="H" onerror="handleLogoError(this)">
                            </div>
                        </a>
                        <img src="" alt="" class="header-logo" id="header-logo-img">
                    </div>
                    <div class="header-right">
                        <img src="images/ai2-logo.png" alt="ai¬≤">
                    </div>
                </div>
                <div class="header-controls">
                    <select class="filter-select" id="client-filter" onchange="applyFilters()">
                        <option value="all">All Clients</option>
                    </select>
                    <span class="date" id="today-date"></span>
                </div>
            </header>
            <main id="content">
                <div class="loading">
                    <div class="loading-spinner"></div>
                    <p>Loading jobs...</p>
                </div>
            </main>
        </div>
    </div>

    <script>
        const API_BASE = 'https://dot-remote-api.up.railway.app';
        const PROXY_BASE = 'https://dot-proxy.up.railway.app';
        const urlParams = new URLSearchParams(window.location.search);
        const isWipMode = urlParams.get('mode') === 'wip';
        
        let currentClient = 'all';
        let allJobs = [];
        let clients = [];
        const CORRECT_PIN = '1919';
        let enteredPin = '';

        if (sessionStorage.getItem('dotUnlocked') === 'true') {
            document.getElementById('pin-screen').classList.add('hidden');
        }

        function enterPin(digit) {
            if (enteredPin.length >= 4) return;
            enteredPin += digit;
            updatePinDots();
            if (enteredPin.length === 4) setTimeout(checkPin, 150);
        }

        function deletePin() {
            enteredPin = enteredPin.slice(0, -1);
            updatePinDots();
        }

        function updatePinDots() {
            for (let i = 0; i < 4; i++) {
                const dot = document.getElementById('dot-' + i);
                dot.classList.remove('filled', 'error');
                if (i < enteredPin.length) dot.classList.add('filled');
            }
        }

        function checkPin() {
            if (enteredPin === CORRECT_PIN) {
                sessionStorage.setItem('dotUnlocked', 'true');
                document.getElementById('pin-screen').classList.add('hidden');
            } else {
                document.querySelectorAll('.pin-dot').forEach(d => d.classList.add('error'));
                setTimeout(() => { enteredPin = ''; updatePinDots(); }, 400);
            }
        }

        function setHeaderImage() {
            const img = document.getElementById('header-logo-img');
            if (isWipMode) {
                img.src = 'images/Hub-Wip-Header.png';
                img.alt = 'WIP';
                document.title = 'Dot WIP';
            } else {
                img.src = 'images/Hub-Todo-Header.png';
                img.alt = 'TO DO';
                document.title = 'Dot To Do';
            }
        }
        setHeaderImage();

        const today = new Date();
        document.getElementById('today-date').textContent = today.toLocaleDateString('en-NZ', { weekday: 'short', day: 'numeric', month: 'short' });

        function formatDueDate(d) { if (!d) return 'TBC'; return new Date(d).toLocaleDateString('en-NZ', { weekday: 'short', day: 'numeric' }); }
        function formatDateForInput(d) { if (!d) return ''; return new Date(d).toISOString().split('T')[0]; }
        function getDaysUntilDue(d) { if (!d) return 999; return Math.ceil((new Date(d) - new Date()) / 86400000); }
        function getDaysSinceUpdate(d) { if (!d) return 999; return Math.floor((new Date() - new Date(d)) / 86400000); }
        function getDaysAgoClass(days) { return days > 7 ? 'days-ago stale' : 'days-ago'; }
        function getLogoUrl(code) { return 'images/logos/' + code + '.png'; }
        function handleLogoError(img) { img.onerror = null; img.src = 'images/logos/unknown.png'; }

        function applyFilters() {
            currentClient = document.getElementById('client-filter').value;
            updateHeaderLogo();
            render();
        }

        function updateHeaderLogo() {
            const logo = document.getElementById('header-client-logo');
            const content = document.getElementById('content');
            if (currentClient === 'all') {
                logo.innerHTML = '<img src="images/logos/HUN.png" alt="H" onerror="handleLogoError(this)">';
                content.classList.remove('single-client');
            } else {
                logo.innerHTML = '<img src="' + getLogoUrl(currentClient) + '" alt="' + currentClient + '" onerror="handleLogoError(this)">';
                content.classList.add('single-client');
            }
        }

        function getFilteredJobs() {
            return currentClient === 'all' ? allJobs.slice() : allJobs.filter(function(j) { return j.clientCode === currentClient; });
        }

        function groupByTodo(jobs) {
            var g = { doNow: [], doSoon: [], other: [], incoming: [] };
            jobs.forEach(function(j) {
                if (j.status === 'Incoming') g.incoming.push(j);
                else if (j.status === 'On Hold' || j.status === 'Completed') {}
                else {
                    var d = getDaysUntilDue(j.updateDue);
                    if (d <= 1) g.doNow.push(j);
                    else if (d <= 7) g.doSoon.push(j);
                    else g.other.push(j);
                }
            });
            var s = function(a, b) { return getDaysUntilDue(a.updateDue) - getDaysUntilDue(b.updateDue); };
            Object.values(g).forEach(function(arr) { arr.sort(s); });
            return {
                leftTop: { title: 'Do It Now', jobs: g.doNow, compact: false },
                rightTop: { title: 'Do It Soon', jobs: g.doSoon, compact: false },
                leftBottom: { title: 'Incoming', jobs: g.incoming, compact: true },
                rightBottom: { title: 'Other', jobs: g.other, compact: true }
            };
        }

        function groupByWip(jobs) {
            var g = { inProgress: [], withClient: [], onHold: [], incoming: [] };
            jobs.forEach(function(j) {
                if (j.status === 'Incoming') g.incoming.push(j);
                else if (j.status === 'On Hold') g.onHold.push(j);
                else if (j.status === 'Completed') {}
                else if (j.withClient) g.withClient.push(j);
                else g.inProgress.push(j);
            });
            var s = function(a, b) { return getDaysUntilDue(a.updateDue) - getDaysUntilDue(b.updateDue); };
            Object.values(g).forEach(function(arr) { arr.sort(s); });
            return {
                leftTop: { title: 'In Progress', jobs: g.inProgress, compact: false },
                rightTop: { title: 'With Client', jobs: g.withClient, compact: false },
                leftBottom: { title: 'Incoming', jobs: g.incoming, compact: true },
                rightBottom: { title: 'On Hold', jobs: g.onHold, compact: true }
            };
        }

        function createJobCard(job) {
            var dueDate = formatDueDate(job.updateDue);
            var daysAgo = getDaysSinceUpdate(job.lastUpdated);
            return '<div class="job-card" onclick="toggleCard(this)" data-job="' + job.jobNumber + '">' +
                '<div class="job-header">' +
                    '<div class="job-logo"><img src="' + getLogoUrl(job.clientCode) + '" alt="' + job.clientCode + '" onerror="handleLogoError(this)"></div>' +
                    '<div class="job-main">' +
                        '<div class="job-title-row">' +
                            '<span class="job-title">' + job.jobNumber + ' ‚Äî ' + job.jobName + '</span>' +
                            '<span class="expand-icon">‚åÑ</span>' +
                        '</div>' +
                        '<div class="job-update-preview">' + (job.update || 'No updates yet') + '</div>' +
                        '<div class="job-meta-compact">' +
                            'üïê ' + dueDate +
                            '<span class="dot">¬∑</span>' +
                            '<span class="stage-tag">' + job.stage + '</span>' +
                            '<span class="dot">¬∑</span>' +
                            '<span class="' + getDaysAgoClass(daysAgo) + '">' + daysAgo + ' days ago</span>' +
                        '</div>' +
                    '</div>' +
                '</div>' +
                '<div class="job-expanded">' +
                    '<div class="section-label">The Project</div>' +
                    '<div class="job-description">' + (job.description || 'No description') + '</div>' +
                    '<div class="section-label" style="margin-top:14px">Client Owner</div>' +
                    '<div class="job-owner">' + (job.projectOwner || 'TBC') + '</div>' +
                    '<div class="job-controls">' +
                        '<div class="control-group">' +
                            '<span class="control-label">Stage</span>' +
                            '<select class="control-select" onclick="event.stopPropagation()" onchange="updateJobField(\'' + job.jobNumber + '\',\'stage\',this.value)">' +
                                '<option' + (job.stage==='Clarify'?' selected':'') + '>Clarify</option>' +
                                '<option' + (job.stage==='Simplify'?' selected':'') + '>Simplify</option>' +
                                '<option' + (job.stage==='Craft'?' selected':'') + '>Craft</option>' +
                                '<option' + (job.stage==='Refine'?' selected':'') + '>Refine</option>' +
                                '<option' + (job.stage==='Deliver'?' selected':'') + '>Deliver</option>' +
                            '</select>' +
                        '</div>' +
                        '<div class="control-group">' +
                            '<span class="control-label">Status</span>' +
                            '<select class="control-select" onclick="event.stopPropagation()" onchange="updateJobField(\'' + job.jobNumber + '\',\'status\',this.value)">' +
                                '<option' + (job.status==='Incoming'?' selected':'') + '>Incoming</option>' +
                                '<option' + (job.status==='In Progress'?' selected':'') + '>In Progress</option>' +
                                '<option' + (job.status==='On Hold'?' selected':'') + '>On Hold</option>' +
                                '<option' + (job.status==='Completed'?' selected':'') + '>Completed</option>' +
                            '</select>' +
                        '</div>' +
                    '</div>' +
                    '<div class="job-dates">' +
                        '<div class="date-group">' +
                            '<span class="control-label">Update Due</span>' +
                            '<input type="date" class="date-input" value="' + formatDateForInput(job.updateDue) + '" onclick="event.stopPropagation()" onchange="updateJobField(\'' + job.jobNumber + '\',\'updateDue\',this.value)">' +
                        '</div>' +
                        '<div class="date-group">' +
                            '<span class="control-label">Live Date</span>' +
                            '<input type="date" class="date-input" value="' + formatDateForInput(job.liveDate) + '" onclick="event.stopPropagation()" onchange="updateJobField(\'' + job.jobNumber + '\',\'liveDate\',this.value)">' +
                        '</div>' +
                    '</div>' +
                    '<div class="section-label">New Update</div>' +
                    '<div class="job-actions">' +
                        '<input type="text" class="update-input" placeholder="What\'s the latest?" onclick="event.stopPropagation()" data-job="' + job.jobNumber + '">' +
                        '<button class="pill-btn" onclick="event.stopPropagation();submitUpdate(\'' + job.jobNumber + '\',this)">UPDATE</button>' +
                    '</div>' +
                    '<div class="job-footer">' +
                        '<a href="' + (job.channelUrl||'#') + '" class="teams-link" target="_blank" onclick="event.stopPropagation()">‚Üó TEAMS</a>' +
                        '<div class="with-client-toggle" onclick="event.stopPropagation()">' +
                            '<span class="with-client-label">With Client</span>' +
                            '<label class="toggle">' +
                                '<input type="checkbox"' + (job.withClient?' checked':'') + ' onchange="updateJobField(\'' + job.jobNumber + '\',\'withClient\',this.checked)">' +
                                '<span class="toggle-slider"></span>' +
                            '</label>' +
                        '</div>' +
                    '</div>' +
                '</div>' +
            '</div>';
        }

        function createJobRow(job) {
            var dueDate = formatDueDate(job.updateDue);
            var daysAgo = getDaysSinceUpdate(job.lastUpdated);
            return '<div class="job-row" onclick="window.open(\'' + (job.channelUrl||'#') + '\',\'_blank\')" data-job="' + job.jobNumber + '">' +
                '<div class="job-header">' +
                    '<div class="job-logo"><img src="' + getLogoUrl(job.clientCode) + '" alt="' + job.clientCode + '" onerror="handleLogoError(this)"></div>' +
                    '<div class="job-main">' +
                        '<span class="job-title">' + job.jobNumber + ' ‚Äî ' + job.jobName + '</span>' +
                        '<span class="job-meta-inline">' +
                            'üïê ' + dueDate +
                            '<span class="dot">¬∑</span>' +
                            '<span class="' + getDaysAgoClass(daysAgo) + '">' + daysAgo + 'd</span>' +
                        '</span>' +
                    '</div>' +
                '</div>' +
            '</div>';
        }

        function renderSection(section) {
            if (section.jobs.length === 0) {
                return '<div class="section"><div class="section-title">' + section.title + '</div><div class="empty-section">No jobs</div></div>';
            }
            var html = '<div class="section"><div class="section-title">' + section.title + '</div>';
            section.jobs.forEach(function(j) {
                html += section.compact ? createJobRow(j) : createJobCard(j);
            });
            html += '</div>';
            return html;
        }

        function render() {
            var jobs = getFilteredJobs();
            var sections = isWipMode ? groupByWip(jobs) : groupByTodo(jobs);
            document.getElementById('content').innerHTML =
                '<div class="column">' + renderSection(sections.leftTop) + renderSection(sections.leftBottom) + '</div>' +
                '<div class="column">' + renderSection(sections.rightTop) + renderSection(sections.rightBottom) + '</div>';
        }

        function toggleCard(card) { card.classList.toggle('expanded'); }

        function submitUpdate(jobNumber, btn) {
            var card = btn.closest('.job-card');
            var input = card.querySelector('.update-input');
            var message = input.value.trim();
            if (!message) return;

            btn.disabled = true;
            btn.textContent = 'SENDING...';

            fetch(PROXY_BASE + '/proxy/update', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ clientCode: jobNumber.split(' ')[0], jobNumber: jobNumber, message: message })
            })
            .then(function(res) {
                if (res.ok) {
                    btn.textContent = '‚úì DONE';
                    btn.classList.add('success');
                    input.value = '';
                    card.querySelector('.job-update-preview').textContent = message;
                    setTimeout(function() { btn.textContent = 'UPDATE'; btn.classList.remove('success'); btn.disabled = false; }, 2000);
                } else {
                    throw new Error('Failed');
                }
            })
            .catch(function(e) {
                btn.textContent = 'ERROR';
                setTimeout(function() { btn.textContent = 'UPDATE'; btn.disabled = false; }, 2000);
            });
        }

        function showToast(message, type) {
            var toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = 'toast ' + type + ' visible';
            setTimeout(function() { toast.classList.remove('visible'); }, 2500);
        }

        function updateJobField(jobNumber, field, value) {
            // Optimistic UI: update local data immediately
            var job = allJobs.find(function(j) { return j.jobNumber === jobNumber; });
            var oldValue = job ? job[field] : null;
            
            if (job) {
                job[field] = value;
                // Re-render immediately if affects grouping
                if (field === 'status' || field === 'withClient') {
                    render();
                }
            }
            
            // Build the update payload
            var payload = {};
            payload[field] = value;
            
            fetch(API_BASE + '/job/' + encodeURIComponent(jobNumber) + '/update', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            })
            .then(function(res) {
                if (!res.ok) throw new Error('Update failed');
                return res.json();
            })
            .then(function(data) {
                showToast('On it.', 'success');
            })
            .catch(function(e) {
                // Revert on failure
                if (job && oldValue !== null) {
                    job[field] = oldValue;
                    if (field === 'status' || field === 'withClient') {
                        render();
                    }
                }
                showToast("Doh, that didn't work.", 'error');
            });
        }

        function loadClients() {
            fetch(API_BASE + '/clients')
            .then(function(res) { return res.json(); })
            .then(function(data) { clients = data; populateClientDropdown(); })
            .catch(function() {
                clients = [{code:'SKY',name:'Sky TV'},{code:'ONE',name:'One NZ'},{code:'HUN',name:'Hunch'},{code:'FIS',name:'Fisher Funds'},{code:'TOW',name:'Tower Insurance'}];
                populateClientDropdown();
            });
        }

        function populateClientDropdown() {
            var sel = document.getElementById('client-filter');
            sel.innerHTML = '<option value="all">All Clients</option>';
            clients.forEach(function(c) {
                var o = document.createElement('option');
                o.value = c.code;
                o.textContent = c.name;
                sel.appendChild(o);
            });
        }

        function loadJobs() {
            fetch(API_BASE + '/jobs/all')
            .then(function(res) { return res.json(); })
            .then(function(data) { allJobs = data; render(); })
            .catch(function() {
                allJobs = [
                    {jobNumber:'SKY 017',jobName:'Faulty Swap/Upgrade',clientCode:'SKY',description:'Refresh the Faulty/Swap email journey',projectOwner:'Mikaila Chen',update:'Copy feedback with us',updateDue:'2026-01-09',liveDate:'2026-01-15',lastUpdated:'2026-01-06',stage:'Refine',status:'In Progress',withClient:false,channelUrl:'https://teams.microsoft.com'},
                    {jobNumber:'SKY 018',jobName:'Offboarding Journey',clientCode:'SKY',description:'Customer offboarding sequence',projectOwner:'Mikaila Chen',update:'With Mikaila for feedback',updateDue:'2026-01-07',liveDate:'2026-01-20',lastUpdated:'2025-12-31',stage:'Simplify',status:'In Progress',withClient:true,channelUrl:'https://teams.microsoft.com'},
                    {jobNumber:'HUN 057',jobName:'Hunch Fix for 26',clientCode:'HUN',description:'Develop Dot World',projectOwner:'Michael Goldthorpe',update:'Debugging in progress',updateDue:'2026-01-13',liveDate:'2026-01-31',lastUpdated:'2026-01-05',stage:'Craft',status:'In Progress',withClient:false,channelUrl:'https://teams.microsoft.com'},
                    {jobNumber:'HUN 056',jobName:'Grrow Logo',clientCode:'HUN',description:'Simple logo for Grrow',projectOwner:'Michael Goldthorpe',update:'Review and feedback on logos',updateDue:'2026-01-08',liveDate:'2026-01-05',lastUpdated:'2025-12-31',stage:'Refine',status:'In Progress',withClient:true,channelUrl:'https://teams.microsoft.com'},
                    {jobNumber:'ONE 090',jobName:'April Price Increase',clientCode:'ONE',description:'Price increase communications',projectOwner:'Sarah Chen',update:'Feedback from Jess/Anita',updateDue:'2026-01-20',liveDate:'2026-04-01',lastUpdated:'2026-01-01',stage:'Refine',status:'In Progress',withClient:false,channelUrl:'https://teams.microsoft.com'},
                    {jobNumber:'FIS 022',jobName:'Nest Evolution',clientCode:'FIS',description:'Initial brief received',projectOwner:'Jade Jordan',update:'Initial brief received',updateDue:null,liveDate:null,lastUpdated:'2026-01-07',stage:'Triage',status:'Incoming',withClient:false,channelUrl:'https://teams.microsoft.com'},
                    {jobNumber:'TOW 087',jobName:'8-Month Health Check',clientCode:'TOW',description:'Know your numbers',projectOwner:'Paige Buckland',update:'Concept developed',updateDue:'2026-01-06',liveDate:'2026-02-02',lastUpdated:'2026-01-06',stage:'Simplify',status:'In Progress',withClient:false,channelUrl:'https://teams.microsoft.com'},
                    {jobNumber:'SKY 010',jobName:'Level Up',clientCode:'SKY',description:'Sky Level Up programme',projectOwner:'Glennis Chan',update:'With Sky for next steps',updateDue:'2026-01-23',liveDate:null,lastUpdated:'2025-12-31',stage:'Simplify',status:'On Hold',withClient:true,channelUrl:'https://teams.microsoft.com'}
                ];
                render();
            });
        }

        document.addEventListener('DOMContentLoaded', function() {
            loadClients();
            loadJobs();
        });
    </script>
</body>
</html>
